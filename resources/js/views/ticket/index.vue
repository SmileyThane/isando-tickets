<template>
    <v-container fluid>
        <v-toolbar flat>
        <v-tabs
            v-model="activeTab"
            :color="themeBgColor"
        >
            <v-tab v-for="item in tabs" :key="item.id" :value="item.id">{{item.name}}</v-tab>
        </v-tabs>
            <v-spacer></v-spacer>
            <v-tooltip left>
                <template v-slot:activator="{ on, attrs }">
                    <v-btn
                        text
                        v-bind="attrs"
                        v-on="on"
                    >
                        <v-icon>mdi-pencil</v-icon>
                    </v-btn>
                </template>
                <span>Coming soon</span>
            </v-tooltip>
        </v-toolbar>
        <v-tabs-items v-model="activeTab">
            <v-tab-item
                v-for="item in tabs"
                :key="item.id"
            >
                <v-snackbar
                    v-model="snackbar"
                    :bottom="true"
                    :color="actionColor"
                    :right="true"
                >
                    {{ snackbarMessage }}
                </v-snackbar>
                <v-data-table
                    :expanded.sync="expanded"
                    :footer-props="footerProps"
                    :headers="headers"
                    :items="tickets"
                    :loading="loading"
                    :loading-text="langMap.main.loading"
                    :options.sync="options"
                    :server-items-length="totalTickets"
                    :single-expand="singleExpand"
                    class="elevation-4"
                    fixed-header
                    dense
                    hide-default-footer
                    item-key="id"
                    show-expand
                    @click:row="showItem"
                >
                    <template v-slot:top>
                        <v-row style="padding-top: 10px;">
                            <v-col md="5" sm="12">
                                <v-text-field
                                    v-model="ticketsSearch"
                                    :color="themeBgColor"
                                    :disabled="filterId !== ''"
                                    :label="langMap.main.search"
                                    hide-details
                                    prepend-icon="mdi-magnify"
                                    style="padding-top: 4px;"
                                    @input="getTickets(); updateUrl();"
                                >
                                    <template slot="prepend">
                                        <v-menu
                                            bottom
                                            rounded
                                            transition="slide-y-transition"
                                        >
                                            <template v-slot:activator="{ on: menu, attrs }">
                                                <v-btn
                                                    text
                                                    v-bind="attrs"
                                                    v-on="{...menu}"
                                                    small
                                                >
                                                <span v-if="searchLabel !== ''">
                                                    {{ searchLabel }}
                                                </span>
                                                    <v-icon v-else>$expand</v-icon>
                                                </v-btn>
                                            </template>
                                            <v-list
                                                dense
                                            >
                                                <v-list-item
                                                    v-for="item in searchCategories"
                                                    :key="item.id"
                                                    link
                                                    @click="selectSearchCategory(item)"
                                                >
                                                    <v-list-item-title>
                                                        {{ item.name }}
                                                    </v-list-item-title>
                                                </v-list-item>
                                            </v-list>
                                        </v-menu>
                                    </template>
                                </v-text-field>
                            </v-col>
                            <v-col md="5" sm="12">
                                <v-autocomplete
                                    v-if="!filterPanel"
                                    v-model="filterId"
                                    :color="themeBgColor"
                                    :item-color="themeBgColor"
                                    :items="filters"
                                    :label="langMap.filter.saved_filters"
                                    style="align-items: flex-end;"
                                    clearable
                                    dense
                                    hide-details
                                    item-text="name"
                                    item-value="id"
                                    @change="getTickets"
                                >
                                    <template v-slot:append-outer>
                                        <v-icon
                                            :disabled="filterId === ''"
                                            @click="removeFilter"
                                        >
                                            mdi-delete
                                        </v-icon>
                                    </template>
                                    <template slot="prepend">
                                        <v-menu
                                            bottom
                                            rounded
                                            transition="slide-y-transition"
                                        >
                                            <template v-slot:activator="{ on: menu, attrs }">
                                                <v-btn
                                                    text
                                                    v-if="!filterPanel"
                                                    small
                                                    @click="filterPanel = true"
                                                >
                                                    <v-icon>mdi-filter</v-icon>
                                                </v-btn>
                                            </template>
                                        </v-menu>
                                    </template>
                                </v-autocomplete>
                                <v-text-field
                                    v-if="filterPanel"
                                    v-model="filterName"
                                    :color="themeBgColor"
                                    :label="langMap.main.name"
                                    style="margin-bottom: 0;"
                                    dense
                                >
                                    <template slot="prepend">
                                        <v-menu
                                            bottom
                                            rounded
                                            transition="slide-y-transition"
                                        >
                                            <template v-slot:activator="{ on: menu, attrs }">
                                                <v-btn
                                                    v-if="filterPanel"
                                                    text
                                                    small
                                                    @click="saveFilter"
                                                >
                                                    <v-icon>mdi-filter-plus</v-icon>
                                                </v-btn>
                                            </template>
                                        </v-menu>
                                    </template>
                                </v-text-field>
                            </v-col>
                            <v-col md="1" sm="12">
                                <v-select
                                    v-model="options.itemsPerPage"
                                    :color="themeBgColor"
                                    :item-color="themeBgColor"
                                    :items="footerProps.itemsPerPageOptions"
                                    :label="langMap.main.items_per_page"
                                    hide-details
                                    style="padding-top: 4px;"
                                    @change="updateItemsCount"
                                ></v-select>
                            </v-col>
                            <v-col md="1" sm="12">
                                <v-pagination v-model="tablePage"
                                              :color="themeBgColor"
                                              :length="lastPage"
                                              :page="options.page"
                                              :total-visible="0"
                                              class="mx-4 d-flex"
                                              circle
                                >
                                </v-pagination>
                            </v-col>
                        </v-row>
                        <v-expand-transition>
                            <v-row v-show="filterPanel">
                                <v-col v-for="filterParam in filterParams"
                                       :key="filterParam.name"
                                       :cols="filterParam.flex"
                                       class="mx-4"
                                >
                                    <v-checkbox
                                        v-model="filterParam.active"
                                        :color="themeBgColor"
                                        :label="filterParam.name"
                                    >
                                    </v-checkbox>
                                    <v-expand-transition>
                                        <v-card
                                            v-show="filterParam.active"
                                            elevation="5"
                                        >
                                            <v-card-text style="padding: 5px 10px ;">
                                                <v-select
                                                    v-model="filterParam.selectedCompareParam"
                                                    :color="themeBgColor"
                                                    :items="filterParam.compareParams"
                                                    :label="langMap.filter.compare_param"
                                                    hide-details
                                                    item-text="name"
                                                    item-value="value"
                                                ></v-select>
                                                <v-select
                                                    v-if="filterParam.type === 'select'"
                                                    v-model="filterParam.value"
                                                    :color="themeBgColor"
                                                    :items="filterParam.prefilled_values"
                                                    :label="langMap.filter.value"
                                                    hide-details
                                                    item-text="name"
                                                    item-value="id"
                                                    @change="manageFilter"
                                                >
                                                </v-select>
                                                <v-text-field
                                                    v-if="filterParam.type === 'string'"
                                                    v-model="filterParam.value"
                                                    :color="themeBgColor"
                                                    hide-details
                                                    label="value"
                                                    @input="manageFilter"
                                                >
                                                </v-text-field>
                                            </v-card-text>
                                        </v-card>
                                    </v-expand-transition>
                                </v-col>
                            </v-row>
                        </v-expand-transition>
                    </template>
                    <template v-slot:footer>
                        <v-pagination v-model="tablePage"
                                      :color="themeBgColor"
                                      :length="lastPage"
                                      :page="options.page"
                                      :total-visible="5"
                                      circle
                        >
                        </v-pagination>
                    </template>
                    <template v-slot:item.ticket_type_id="{ item }">
                        {{$helpers.i18n.localized(item.ticket_type)}}
                        <!--                <v-tooltip top>-->
                        <!--                    <template v-slot:activator="{ on, attrs }">-->
                        <!--                        <v-icon v-if="item.ticket_type.icon" small-->
                        <!--                                v-on="on"-->
                        <!--                                v-text="item.ticket_type.icon"/>-->
                        <!--                        <v-icon v-else-->
                        <!--                                :title="$helpers.i18n.localized(item.ticket_type)"-->
                        <!--                                small-->
                        <!--                                v-on="on"-->
                        <!--                        >-->
                        <!--                            mdi-alert-->
                        <!--                        </v-icon>-->
                        <!--                    </template>-->
                        <!--                    {{ $helpers.i18n.localized(item.ticket_type) }}-->
                        <!--                </v-tooltip>-->
                    </template>
                    <template v-slot:item.status.name="{ item }">
                    </template>
                    <template v-slot:item.name="{ index, item }">
                        <v-tooltip bottom>
                            <template v-slot:activator="{ on, attrs }">
                        <span
                            v-bind="attrs"
                            v-on="on"
                            style="display:block; max-width: 350px; text-overflow: ellipsis;overflow: hidden;white-space: nowrap;"
                        >
                            {{item.name}}
                        </span>
                            </template>
                            <span>
                        {{ item.name }}
                    </span>
                        </v-tooltip>
                    </template>
                    <template v-slot:item.data-table-expand="{ index, item }">
                        <v-tooltip top>
                            <template v-slot:activator="{ on, attrs }">
                                <v-btn
                                    :style="`color: ${item.priority.color === 'amber' ? '#FEBE00' : item.priority.color}`"
                                    dark
                                    icon
                                    x-small
                                    v-bind="attrs"
                                    v-on="on"
                                    @click.prevent.stop="expandItem(item)"
                                >
                                    <v-icon x-small>
                                        mdi-checkbox-blank-circle
                                        <!--                                {{-->
                                        <!--                                    expanded.indexOf(item) === -1 ? 'mdi-lol' : 'mdi-arrow-up-bold-circle'-->
                                        <!--                                }}-->
                                    </v-icon>
                                </v-btn>
                            </template>
                            <span>{{ item.priority.name }}.{{ item.status.name }}</span>
                        </v-tooltip>
                    </template>
                    <template v-slot:item.last_update="{ item }">
                        {{
                            moment(item.last_update).isValid() ? moment(item.last_update).format('DD.MM. hh:mm') : item.last_update
                        }}
                    </template>
                    <template v-slot:item.number="{ item }">
                        <v-tooltip top>
                            <template v-slot:activator="{ on, attrs }">
                                <div v-on="on">
                                    {{ item.number }}
                                    <v-badge :color="item.status.color" dot inline @click="showItem(item)">
                                        <div v-on="on">#{{ item.id }}</div>
                                    </v-badge>
                                </div>


                            </template>
                            {{ item.priority.name }}.{{ item.status.name }}
                        </v-tooltip>
                    </template>
                    <template v-slot:item.category.name="{ item }">
                        {{ item.category ? item.category.name : '' }}
                    </template>
                    <template v-slot:item.product.name="{ item }">
                        {{ item.product ? item.product.name : '' }}
                    </template>
                    <template v-slot:item.assigned_person="{ item }">
                        <div v-if="item.assigned_person && item.assigned_person.user_data" class="justify-center"
                             @click="showItem(item)">
                            {{ item.assigned_person.user_data.full_name }}
                        </div>
                        <div v-else> </div>
                    </template>
                    <!--            <template v-slot:item.actions="{ item }">-->
                    <!--            </template>-->
                    <template v-slot:expanded-item="{ headers, item }">

                        <td :colspan="headers.length">
                            <v-spacer>
                                &nbsp;
                            </v-spacer>
                            <h3>{{ item.number }}</h3>
                            <p><strong>{{ langMap.ticket.contact_name }}:</strong>
                                {{ item.contact && item.contact.user_data ? item.contact.user_data.full_name : '' }}</p>
                            <p><strong>{{ langMap.ticket.contact_email }}:</strong>
                                {{ item.contact && item.contact.user_data ? item.contact.user_data.email : '' }}</p>
                            <p><strong>{{ langMap.ticket.due_date }}:</strong> {{ item.due_date }}</p>
                            <p><strong>{{ langMap.ticket.access_details }}:</strong> {{ item.access_details }}</p>
                            <p><strong>{{ langMap.main.actions }}:</strong></p>
                            <p>
                                <template>
                                    <v-tooltip top>
                                        <template v-slot:activator="{ on }">
                                            <v-btn
                                                color="grey"
                                                v-on="on"
                                                dark
                                                fab
                                                x-small
                                                @click="showItem(item)"
                                            >
                                                <v-icon
                                                >
                                                    mdi-eye
                                                </v-icon>
                                            </v-btn>
                                        </template>
                                        <span>{{langMap.ticket.view}}</span>
                                    </v-tooltip>
                                </template>

                                <template>
                                    <v-tooltip top>
                                        <template v-slot:activator="{ on }">
                                            <v-btn
                                                :color="themeBgColor"
                                                v-on="on"
                                                dark
                                                fab
                                                x-small
                                                @click="mergeTicketProcess(item.id)"
                                            >
                                                <v-icon dark>mdi-clipboard-flow</v-icon>
                                            </v-btn>
                                        </template>
                                        <span>{{langMap.ticket.link_tickets}}</span>
                                    </v-tooltip>
                                </template>

                                <template>
                                    <v-tooltip top>
                                        <template v-slot:activator="{ on }">
                                            <v-btn
                                                color="error"
                                                v-on="on"
                                                dark
                                                fab
                                                x-small
                                                @click="ticketDeleteProcess(item)"
                                            >
                                                <v-icon
                                                >
                                                    mdi-delete
                                                </v-icon>
                                            </v-btn>
                                        </template>
                                        <span>{{langMap.individuals.delete}}</span>
                                    </v-tooltip>
                                </template>

                                <template>
                                    <v-tooltip top>
                                        <template v-slot:activator="{ on }">
                                            <v-btn
                                                color="grey"
                                                v-on="on"
                                                dark
                                                fab
                                                x-small
                                                @click="closeTicketDialog = true"
                                            >
                                                <v-icon
                                                >
                                                    mdi-check
                                                </v-icon>
                                            </v-btn>
                                        </template>
                                        <span>{{langMap.main.close}}</span>
                                    </v-tooltip>
                                </template>
                            </p>
                        </td>
                    </template>
                </v-data-table>
                <template>
                    <v-dialog v-model="removeTicketDialog" max-width="480" persistent>
                        <v-card>
                            <v-card-title :style="`color: ${themeFgColor}; background-color: ${themeBgColor};`" class="mb-5">
                                {{ langMap.main.delete_selected }}?
                            </v-card-title>
                            <v-card-actions>
                                <v-spacer></v-spacer>
                                <v-btn color="grey darken-1" text @click="removeTicketDialog = false">{{ langMap.main.cancel }}
                                </v-btn>
                                <v-btn color="red darken-1" text @click="deleteTicket(selectedticketId)">
                                    {{ langMap.main.delete }}
                                </v-btn>
                            </v-card-actions>
                        </v-card>
                    </v-dialog>
                </template>
                <template>
                    <v-dialog v-model="mergeTicketDialog" max-width="480" persistent>
                        <v-card>
                            <v-card-title :style="`color: ${themeFgColor}; background-color: ${themeBgColor};`" class="mb-5">
                                {{ langMap.main.link }}
                            </v-card-title>
                            <v-card-text>
                                <v-autocomplete
                                    v-model="mergeTicketForm.parent_ticket_id"
                                    :color="themeBgColor"
                                    :item-color="themeBgColor"
                                    :items="tickets"
                                    :label="langMap.ticket.subject"
                                    dense
                                    item-text="name"
                                    item-value="id"
                                />
                                <v-autocomplete
                                    v-model="mergeTicketForm.child_ticket_id"
                                    :color="themeBgColor"
                                    :item-color="themeBgColor"
                                    :items="tickets"
                                    :label="langMap.ticket.subject"
                                    dense
                                    item-text="name"
                                    item-value="id"
                                    multiple

                                />
                                <v-textarea
                                    v-model="mergeTicketForm.merge_comment"
                                    :color="themeBgColor"
                                    :label="langMap.main.description"
                                    auto-grow
                                    dense
                                    row-height="25"
                                    rows="2"
                                    shaped
                                />
                            </v-card-text>
                            <v-card-actions>
                                <v-spacer></v-spacer>
                                <v-btn :color="themeBgColor" darken-1 text @click="mergeTicketDialog = false">
                                    {{ langMap.main.cancel }}
                                </v-btn>
                                <v-btn :color="themeBgColor" darken-1 text @click="mergeTicket()">
                                    {{ langMap.main.link }}
                                </v-btn>
                            </v-card-actions>
                        </v-card>
                    </v-dialog>
                </template>
                <template>
                    <v-dialog v-model="closeTicketDialog" max-width="540" persistent>
                        <v-card>
                            <v-card-title :style="`color: ${themeFgColor}; background-color: ${themeBgColor};`">
                                {{ langMap.ticket.close_ticket_title }}
                            </v-card-title>
                            <v-card-actions>
                                <v-spacer></v-spacer>
                                <v-btn color="grey darken-1" text @click="closeTicketDialog = false">{{ langMap.main.cancel }}
                                </v-btn>
                                <v-btn color="red darken-1" text @click="closeTicket()">
                                    {{ langMap.ticket.close_ticket }}
                                </v-btn>
                            </v-card-actions>
                        </v-card>
                    </v-dialog>
                </template>
            </v-tab-item>
        </v-tabs-items>

    </v-container>
</template>

<style scoped>
.v-data-table /deep/ .sticky-header {
    position: sticky;
}

.v-data-table /deep/ .v-data-table__wrapper {
    overflow: unset;
    z-index: 5;
    position: relative;
    background: #fff;
}
</style>

<script>
import EventBus from "../../components/EventBus";

export default {
    props: {
        page: {
            type: [String, Number],
            default: 1
        },
        tab: {
            type: [String, Number],
            default: 1
        },
    },
    data() {
        return {
            langMap: this.$store.state.lang.lang_map,
            themeFgColor: this.$store.state.themeFgColor,
            themeBgColor: this.$store.state.themeBgColor,
            clientId: 6,
            snackbar: false,
            actionColor: '',
            snackbarMessage: '',
            expanded: [],
            singleExpand: false,
            totalTickets: 0,
            lastPage: 0,
            loading: this.themeBgColor,
            products: [],
            priorities: [],
            types: [],
            tablePage: 1,
            options: {
                page: this.page ? parseInt(this.page) : 1,
                sortDesc: [true],
                sortBy: ['id'],
                withSpam: false,
                onlyOpen: true,
                onlyForUser: false,
                itemsPerPage: localStorage.itemsPerPage ? parseInt(localStorage.itemsPerPage) : 10,
                priority: null,
                type: null,
            },
            footerProps: {
                showFirstLastPage: true,
                itemsPerPageOptions: [
                    {
                        'text': 10,
                        'value': 10,
                    },
                    {
                        'text': 20,
                        'value': 20,
                    },
                    {
                        'text': 50,
                        'value': 50,
                    },
                    {
                        'text': 100,
                        'value': 100,
                    },
                    {
                        'text': this.$store.state.lang.lang_map.sidebar.all,
                        'value': 10000,
                    }
                ],
            },
            filterParams: [
                {
                    active: false,
                    value: null,
                    selectedCompareParam: null,
                    query_fields: [],
                    compareParams: []
                }
            ],
            searchLabel: 'Subject',
            searchCategories: [
                {
                    id: 1,
                    name: 'ID'
                },
                {
                    id: 2,
                    name: 'Subject'
                },
                {
                    id: 3,
                    name: 'Contact'
                },
                {
                    id: 3,
                    name: 'Company'
                }
            ],
            headers: [
                {text: '', value: 'data-table-expand', width: '20px'},
                // {
                //     text: 'ID',
                //     align: 'start',
                //     sortable: false,
                //     value: 'id',
                // },
                {text: `${this.$store.state.lang.lang_map.ticket.number}`, value: 'number', width: '160px'},
                // {text: `${this.$store.state.lang.lang_map.ticket.status}`, value: 'status.name'},
                {text: `${this.$store.state.lang.lang_map.ticket.last_update}`, value: 'last_update', width: '100px'},
                // {text: `${this.$store.state.lang.lang_map.ticket.priority}`, value: 'priority.name'},
                {text: `${this.$store.state.lang.lang_map.ticket.type}`, value: 'ticket_type_id', width: '150px'},
                // {text: `${this.$store.state.lang.lang_map.main.category}`, value: 'category.name'},
                {text: `${this.$store.state.lang.lang_map.ticket.company_from}`, value: 'from.name', width: '250px'},
                {text: `${this.$store.state.lang.lang_map.main.contact}`, value: 'contact.user_data.full_name', width: '150px'},
                {text: `${this.$store.state.lang.lang_map.ticket.subject}`, value: 'name', width: '260px'},
                {text: `${this.$store.state.lang.lang_map.main.product}`, value: 'product.name', width: '200px'},
                {text: `${this.$store.state.lang.lang_map.team.members}`, value: 'assigned_person', width: '80px'},

            ],
            mergeTicketForm: {
                parent_ticket_id: null,
                child_ticket_id: null,
                merge_comment: null
            },
            minifiedTickets: false,
            ticketsSearch: '',
            tickets: [],
            removeTicketDialog: false,
            mergeTicketDialog: false,
            selectedticketId: null,
            filterName: '',
            filterPanel: false,
            filters: [],
            queryArray: [],
            tempFilter: [],
            filterId: '',
            ticket: {
                status_id: null,
                to_company_user_id: null,
                attachments: [{
                    name: '',
                    link: ''
                },
                ],
                files: [],
                from: {
                    name: ''
                },
                from_entity_type: '',
                from_entity_id: '',
                to: {
                    name: ''
                },
                priority: {
                    name: ''
                },
                can_be_edited: '',
                contact: {
                    user_data: {
                        name: '',
                        surname: '',
                        email: ''
                    }
                },
                status: {
                    name: ''
                },
                to_entity_type: '',
                to_entity_id: null,
                to_team_id: null,
                contact_company_user_id: null,
                to_product_id: null,
                priority_id: null,
                name: '',
                description: '',
                availability: '',
                connection_details: '',
                access_details: '',
                merge_comment: '',
                answers: [
                    {
                        created_at: '',
                        files: [],
                        attachments: [{
                            name: '',
                            link: ''
                        }],
                        employee: {
                            user_data: {
                                name: '',
                                email: '',
                                surname: ''
                            }
                        },
                        answer: '',
                        is_internal: false
                    }
                ],
                histories: [
                    {
                        created_at: '',
                        files: [],
                        attachments: [{
                            name: '',
                            link: ''
                        }],
                        employee: {
                            user_data: {
                                name: '',
                                email: ''
                            }
                        },
                        description: ''
                    }
                ],
                notices: [
                    {
                        created_at: '',
                        files: [],
                        attachments: [{
                            name: '',
                            link: ''
                        }],
                        employee: {
                            user_data: {
                                name: '',
                                email: ''
                            }
                        },
                        description: ''
                    }
                ],
                followers: [],
            },
            closeTicketDialog: false,
            tabs: [
                {id: 0, name: this.$store.state.lang.lang_map.ticket_tabs.all},
                {id: 1, name: this.$store.state.lang.lang_map.ticket_tabs.open},
                {id: 2, name: this.$store.state.lang.lang_map.ticket_tabs.my_tickets},
                {id: 3, name: this.$store.state.lang.lang_map.ticket_tabs.urgent_open},
                {id: 4, name: this.$store.state.lang.lang_map.ticket_tabs.internal_open},
                {id: 5, name: this.$store.state.lang.lang_map.ticket_tabs.projects},
                {id: 6, name: this.$store.state.lang.lang_map.ticket_tabs.spam},
                {id: 7, name: this.$store.state.lang.lang_map.ticket_tabs.closed}
            ],
            activeTab: this.tab ? parseInt(this.tab) : 1,
            ticketStatuses: []
        }
    },
    mounted() {
        let that = this;
        this.setOptionsByActiveTab(this.activeTab)
        this.updatePageFromRoute();
        EventBus.$on('update-theme-fg-color', function (color) {
            that.themeFgColor = color;
        });
        EventBus.$on('update-theme-bg-color', function (color) {
            that.themeBgColor = color;
        });
        this.getTicketFilterParameters()
        this.getFilters()
        this.getProducts()
        this.getPriorities()
        this.getTypes()
        this.getStatuses()
        setTimeout(() => {
            if (!this.$helpers.auth.checkPermissionByIds([1])) {
                this.$router.push('knowledge_base')
            }

        }, 500);
    },
    methods: {
        updateUrl() {
            const query = { ...this.$route.query };

            if(this.ticketsSearch?.length) {
                query.search = this.ticketsSearch
            } else {
                delete query.search
            }

            if(this.searchLabel?.length) {
                query.searchLabel = this.searchLabel
            } else {
                delete query.searchLabel
            }

            this.$router.push({ query });
        },
        updatePageFromRoute() {
            if (this.page) {
                this.tablePage = parseInt(this.page) || 1
                this.options.page = parseInt(this.page) || 1;
                this.activeTab = parseInt(this.tab) || 1;
                // this.getTickets();
                this.$router.push({ name: 'ticket_list', query: { page: this.page, tab: this.tab } })
            }
        },
        manageFilter() {
            this.queryArray = [];
            this.filterParams.forEach(filterParam => {
                if (filterParam.active === true) {
                    filterParam.query_fields.forEach(field => {
                        if (filterParam.value && filterParam.selectedCompareParam) {
                            this.queryArray.push({
                                'field': field,
                                'compare_parameter': filterParam.selectedCompareParam,
                                'value': filterParam.value
                            })
                        }
                    });
                }
            });
        },
        expandItem(item) {
            this.ticket = item;
            const query = { ...this.$route.query };
            if (this.expanded.indexOf(item) !== -1) {
                delete query.expanded
                this.expanded = [];
                this.$router.push({ query });
            } else {
                this.expanded.splice(0, 1, item);
                this.$router.push({ query: {...query, expanded: item.id} })
            }
        },
        saveFilter() {
            let data = {
                'name': this.filterName,
                'filter_parameters': this.queryArray
            }
            axios.post('/api/ticket_query', data).then(response => {
                response = response.data
                if (response.success === true) {
                    this.snackbarMessage = 'Filter was created'
                    this.actionColor = 'success'
                    this.snackbar = true;
                    this.filterPanel = false
                    this.getFilters()
                } else {
                    this.snackbarMessage = 'Filter creating error'
                    this.actionColor = 'error'
                    this.snackbar = true;
                }
            });
        },
        removeFilter() {
            axios.delete(`/api/ticket_filters/${this.filterId}`)
                .then(
                    response => {
                        response = response.data
                        if (response.success) {
                            this.filterId = ''
                            this.getFilters()
                        }
                    });
            this.getTickets()
        },
        selectSearchCategory(item) {
            this.searchLabel = item.name
        },
        getProducts() {
            axios.get('/api/product').then(response => {
                response = response.data
                if (response.success === true) {
                    this.products = response.data.data
                }
            });
        },
        getTicketFilterParameters() {
            axios.get('/api/ticket_filter_parameters').then(response => {
                response = response.data
                if (response.success === true) {
                    this.filterParams = response.data
                }

            });
        },
        getPriorities() {
            axios.get('/api/ticket_priorities').then(response => {
                response = response.data
                if (response.success === true) {
                    this.priorities = response.data
                }

            });
        },
        getTypes() {
            axios.get('/api/ticket_types').then(response => {
                response = response.data
                if (response.success === true) {
                    this.types = response.data
                }

            });
        },
        getStatuses() {
            axios.get('/api/ticket_statuses').then(response => {
                response = response.data
                if (response.success === true) {
                    this.ticketStatuses = response.data
                }

            });
        },
        getTickets() {
            this.loading = this.themeBgColor
            if (this.options.sortDesc.length <= 0) {
                this.options.sortBy[0] = 'id'
                this.options.sortDesc[0] = true
            }
            if (this.totalTickets < this.options.itemsPerPage) {
                this.options.page = 1
            }

            axios.get('/api/ticket', {
                params: {
                    search_param: this.searchLabel,
                    search: this.ticketsSearch,
                    sort_by: this.manageSortableField(this.options.sortBy[0]),
                    sort_val: this.options.sortDesc[0],
                    with_spam: this.options.withSpam,
                    only_for_user: this.options.onlyForUser,
                    only_open: this.options.onlyOpen,
                    per_page: this.options.itemsPerPage,
                    minified: this.minifiedTickets,
                    filter_id: this.filterId,
                    page: this.page,
                    priority: this.options.priority,
                    type: this.options.type,
                    status: this.options.status,
                }
            }).then(
                response => {
                    response = response.data
                    if (response.success === true) {
                        this.tickets = response.data.data
                        this.totalTickets = response.data.total
                        this.lastPage = response.data.last_page
                    } else {
                        this.snackbarMessage = this.langMap.main.generic_error;
                        this.actionColor = 'error'
                        this.snackbar = true;
                    }
                    this.loading = false
                });
        },
        getFilters() {
            axios.get(`/api/ticket_filters`)
                .then(
                    response => {
                        response = response.data
                        this.filters = response.data
                    });
        },
        showItem(item) {
            location.href = `/ticket/${item.id}`;
            // this.$router.push()
        },
        ticketDeleteProcess(item) {
            this.selectedticketId = item.id
            this.removeTicketDialog = true
        },
        deleteTicket(id) {
            axios.delete(`/api/ticket/${id}`).then(response => {
                response = response.data
                if (response.success === true) {
                    this.getTickets()
                    this.snackbarMessage = 'Ticket was deleted '
                    this.actionColor = 'success'
                    this.snackbar = true;
                    this.removeTicketDialog = false
                } else {
                    this.snackbarMessage = this.langMap.main.generic_error;
                    this.actionColor = 'error'
                    this.snackbar = true;
                }
            });
        },
        mergeTicketProcess(id) {
            this.mergeTicketForm.parent_ticket_id = id
            this.mergeTicketDialog = true
            this.minifiedTickets = true
        },
        mergeTicket() {
            axios.post('/api/link/ticket', this.mergeTicketForm).then(response => {
                response = response.data
                if (response.success === true) {
                    this.minifiedTickets = false
                    this.getTickets()
                    this.mergeTicketForm.merge_comment = null
                    this.mergeTicketForm.parent_ticket_id = null
                    this.mergeTicketForm.child_ticket_id = null
                    this.mergeTicketDialog = false
                } else {
                    this.snackbarMessage = this.langMap.main.generic_error;
                    this.actionColor = 'error'
                    this.snackbar = true;
                }
            });
        },
        updateItemsCount(value) {
            this.options.itemsPerPage = value
            localStorage.itemsPerPage = value;
            this.options.page = 1
        },
        manageSortableField(value) {
            if (value === 'last_update') return 'updated_at'
            if (value === 'status.name') return 'status_id'
            if (value === 'assigned_person') return 'to_company_user_id'
            if (value === 'product.name') return 'to_product_id'
            if (value === 'name') return 'name'
            if (value === 'from.name') return 'from_entity_id'
            if (value === 'to.name') return 'to_entity_id'
            if (value === 'priority.name') return 'priority_id'
            return value
        },
        updateTicket() {
            axios.patch(`/api/ticket/${this.ticket.id}`, this.ticket).then(response => {
                response = response.data
                if (response.success === true) {
                    this.getTickets()
                    this.updateDialog = false
                } else {
                    this.snackbarMessage = this.langMap.main.generic_error;
                    this.actionColor = 'error'
                    this.snackbar = true;
                }
            });
        },
        closeTicket() {
            this.ticket.status_id = 5;
            this.updateTicket();
            this.expanded = [];
            this.closeTicketDialog = false
        },
        setOptionsByActiveTab(tab){
            const options = this.options;
            const emptyOptions = {
                onlyOpen: false,
                withSpam: false,
                onlyForUser: false,
                priority: null,
                type: null,
                status: null,
            }
            switch (tab) {
                case 0: {
                    return this.options = {
                        ...options,
                        ...emptyOptions,
                        status: this.ticketStatuses.map((status) => status.id)
                    }
                }
                case 1: {
                    return this.options = {
                        ...options,
                        ...emptyOptions,
                        onlyOpen: true,
                        type: this.types.filter((type) => type.id !== 7).map((type) => type.id)
                    }
                }
                case 2: {
                    return this.options = {
                        ...options,
                        ...emptyOptions,
                        onlyForUser: true,
                    }
                }
                case 3: {
                    return this.options = {
                        ...options,
                        ...emptyOptions,
                        onlyOpen: true,
                        priority: 1 ,
                        type: this.types.filter((type) => type.id !== 7).map((type) => type.id)
                    }
                }
                case 4: {
                    return this.options = {
                        ...options,
                        ...emptyOptions,
                        onlyOpen: true,
                        type: 4
                    }
                }
                case 5: {
                    return this.options = {
                        ...options,
                        ...emptyOptions,
                        onlyOpen: true,
                        type: 7
                    }
                }
                case 6: {
                    return this.options = {
                        ...options,
                        ...emptyOptions,
                        withSpam: true,
                    }
                }
                case 7: {
                    return this.options = {
                        ...options,
                        ...emptyOptions,
                        status: this.ticketStatuses.filter((status) => status.id === 5).map((status) => status.id)
                    }
                }
                default: {
                    return this.options = {
                        ...options,
                        ...emptyOptions,
                        onlyOpen: true,
                        type: this.types.filter((type) => type.id !== 7).map((type) => type.id)
                    }
                }
            }
        },
    },
    watch: {
        activeTab(value) {
            this.setOptionsByActiveTab(value)
            this.$router.push({ query: { ...this.$route.query, tab: this.activeTab } });
        },
        '$route.query': function() {
          if(+this.activeTab !== +this.$route.query.tab) {
              this.activeTab = +this.$route.query.tab
          }
        },
        searchLabel: {
            handler: _.debounce(function (v) {
                this.updateUrl();
                this.getTickets();
            }, 500),
            deep: true,
        },
        ticketsSearch: {
            handler: _.debounce(function (v) {
                this.updateUrl();
                this.getTickets();
            }, 500),
                deep: true,
        },
        tickets(){
            if(this.$route.query.expanded && this.tickets.length){
                this.expanded = this.tickets.filter((ticket) => ticket.id.toString() === this.$route.query.expanded.toString())
            }
        },
        options: {
            handler: _.debounce(function (v) {
                this.getTickets();
            }, 500),
            deep: true,
        },
        loading(value) {
            this.$parent.$parent.$refs.container.scrollTop = 0
        },
        page(newValue) {
            this.options.page = parseInt(newValue) || 1;
            this.tablePage = parseInt(newValue) || 1;
        },
        tablePage: function(newValue, oldValue) {
            if (newValue !== oldValue) {
                this.$router.push({ name: 'ticket_list', query: { page: newValue } });
            }
        },
    },
}
</script>

<style>
.v-data-table-header th {
    white-space: nowrap;
}
.v-data-table > .v-data-table__wrapper > table > tbody > tr > td,
.v-data-table > .v-data-table__wrapper > table > tfoot > tr > td,
.v-data-table > .v-data-table__wrapper > table > thead > tr > td {
    height: 0px;
}

</style>
